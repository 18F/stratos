apiVersion: batch/v1
kind: Job
metadata:
  labels:
    app: postflight-job
  name: postflight-job
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "0"
spec:
 template:
     metadata:
       labels:
         app: console
         job: postflight
     spec:
       containers:
        - env:
          - name: PGSQL_HOST
            value: console-postgres-int
          - name: PGSQL_PORT
            value: "5432"
          - name: POSTGRES_USER
            value: postgres
          - name: POSTGRES_PASSWORD_FILE
            value: /etc/secrets/stolon
          - name: PGSQL_DATABASE
            value: console-db
          - name: PGSQL_USER
            value: console
          - name: PGSQL_PASSWORDFILE
            value: /etc/secrets/pgsql-password
          - name: PGSQL_SSL_MODE
            value: disable
          - name: UPGRADE_VOLUME
            value: hsc-upgrade-volume
          - name: UPGRADE_LOCK_FILENAME
            value: upgrade.lock
          - name: HTTP_PROXY
          - name: HTTPS_PROXY
          - name: NO_PROXY
          - name: FTP_PROXY
          - name: SOCKS_PROXY
          - name: PGCONNECT_TIMEOUT
            value: "10"
          image: {{.Values.dockerRegistry}}/{{.Values.dockerOrg}}/{{.Values.images.postflight}}:{{.Values.consoleVersion}}
          name: postflight-job
          volumeMounts:
          - mountPath: /hsc-upgrade-volume
            name: hsc-upgrade-volume
          - mountPath: /etc/secrets/
            name: console-secret
       restartPolicy: OnFailure
       volumes:
       - name: hsc-upgrade-volume
         persistentVolumeClaim:
           claimName: hsc-upgrade-volume
       - name: console-secret
         secret:
           secretName: console-secret
---